#
# Copyright (c) 2023 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#

# every time root/yarn.lock is updated, copy it to tools/build/yarn.lock 
# so that downstream builds can use the second yarn.lock for cachito processes
name: Regenerate-yarn-lock-and-copy-to-subfolders

on:
  push:
    paths:
      - yarn.lock 
      - tools/build/yarn.lock
  pull_request:
    paths:
      - yarn.lock 
      - tools/build/yarn.lock

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          token: ${{secrets.CHE_BOT_GITHUB_TOKEN}}
      - uses: actions/setup-node@v3
        with:
          node-version: "16"
      - name: Regen yarn.lock using yarn v1
        run: |
          yarn --version
          rm -f yarn.lock tools/build/yarn.lock
          yarn install --mode update-lockfile
          cp yarn.lock tools/build/yarn.lock
        env:
          YARN_ENABLE_SCRIPTS: 0 # disable postinstall scripts
          YARN_ENABLE_IMMUTABLE_INSTALLS: false # allow to override yarn.lock files
      - name: Config Git
        run: |
          git config --global user.email "che-bot@eclipse.org"
          git config --global user.name "Che bot"
      - name: Commit changes
        run: |
          git add yarn.lock tools/build/yarn.lock
          git commit --amend --no-edit --signoff
          git push -f
